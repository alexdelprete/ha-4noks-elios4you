# Release v0.4.0-beta.1

**Release Date:** 2025-12-29
**Type:** BETA - Async Telnet Migration
**Claude Model:** Opus 4.5 (claude-opus-4-5-20251101)
**Development Tool:** Claude Code (VSCode Extension)

## Overview

This beta release migrates the integration from a bundled synchronous `telnetlib` implementation to the `telnetlib3` async client library. This architectural change eliminates Home Assistant event loop blocking during telnet I/O operations.

**This is a beta release.** Please test thoroughly and report any issues before this becomes a stable release.

---

## Problem Description

### The Event Loop Blocking Issue

The previous implementation used synchronous blocking I/O for telnet operations:

```python
# OLD PATTERN (Blocking)
def telnet_get_data(self, cmd: str) -> dict | None:
    response = self.E4Uclient.read_until(separator, self._timeout)
    #          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    #          This BLOCKS for up to 5 seconds!
```

**Impact:**
- The Home Assistant event loop was **paused** during every `read_until()` call
- With 5-second timeout, each poll could block the entire system for 5 seconds
- Other integrations, automations, and UI updates would freeze
- Multiple entities could cause significant system-wide delays

### Symptoms Users May Have Experienced

- Sluggish Home Assistant UI during Elios4you polling
- Delays in automation execution
- Other integrations showing intermittent unavailability
- General system responsiveness issues

---

## Solution Implemented

### Full Async Telnet Migration

The integration now uses `telnetlib3.open_connection()` for fully async telnet I/O:

```python
# NEW PATTERN (Non-blocking)
async def _async_send_command(self, cmd: str) -> dict | None:
    self._writer.write(cmd_bytes)
    await self._writer.drain()                    # Yields to event loop
    response = await self._async_read_until(...)  # Yields to event loop
```

**Benefits:**
- Event loop is **FREE** during I/O waits
- Other tasks can run while waiting for device response
- System remains responsive during polling
- No blocking regardless of timeout duration

### Architecture Changes

#### 1. New Async Connection Model

**Before (Bundled sync telnetlib):**
```python
from .telnetlib import Telnet

class E4Utelnet:
    """Wrapper around bundled Telnet library."""
    def __init__(self):
        self.tn: Telnet | None = None

    def open(self, host, port, timeout):
        self.tn = Telnet(host, port, timeout)

    def read_until(self, separator, timeout):
        return self.tn.read_until(separator, timeout)  # BLOCKING!
```

**After (telnetlib3 async client):**
```python
import telnetlib3

# Instance variables
self._reader: asyncio.StreamReader | None = None
self._writer: asyncio.StreamWriter | None = None

# Connection
self._reader, self._writer = await telnetlib3.open_connection(
    self._host, self._port
)
```

#### 2. Custom Async Read Until Helper

Since `telnetlib3` doesn't provide a built-in `read_until()` method, a custom async implementation was created:

```python
async def _async_read_until(
    self,
    separator: bytes,
    timeout: float,
) -> bytes:
    """Async read until separator found or timeout."""
    buffer = b""
    loop = asyncio.get_event_loop()
    end_time = loop.time() + timeout

    while separator not in buffer:
        remaining = end_time - loop.time()
        if remaining <= 0:
            return buffer  # Timeout - return partial

        try:
            chunk = await asyncio.wait_for(
                self._reader.read(1024),
                timeout=remaining,
            )
            if not chunk:
                return buffer  # EOF
            buffer += chunk
        except TimeoutError:
            return buffer

    return buffer
```

**Key Features:**
- Reads in 1KB chunks for efficiency
- Properly handles timeout with remaining time calculation
- Detects EOF (connection closed)
- Returns partial data on timeout for error handling

#### 3. Stream-Based Write Operations

```python
async def _async_send_command(self, cmd: str) -> dict | None:
    # Send command with newline
    cmd_bytes = (cmd.lower() + "\n").encode("utf-8")
    self._writer.write(cmd_bytes)
    await self._writer.drain()  # Ensure data is sent, yields to event loop

    # Read response asynchronously
    response_bytes = await self._async_read_until(b"ready...", self._timeout)
    # ... parse response ...
```

#### 4. Async Connection Management

All connection management methods converted to async:

```python
async def _ensure_connected(self) -> None:
    """Open connection only if needed."""
    if self._is_connection_valid():
        return

    await self._safe_close()

    self._reader, self._writer = await asyncio.wait_for(
        telnetlib3.open_connection(self._host, self._port),
        timeout=self._timeout,
    )

async def _safe_close(self) -> None:
    """Safely close connection with proper cleanup."""
    if self._writer is not None:
        with suppress(Exception):
            self._writer.close()
            await self._writer.wait_closed()
        self._writer = None
        self._reader = None

async def close(self) -> None:
    """Close the telnet connection."""
    await self._safe_close()
```

---

## Migration Summary

| Component | Before (Sync) | After (Async) |
|-----------|---------------|---------------|
| Import | `from .telnetlib import Telnet` | `import telnetlib3` |
| Client | `E4Utelnet()` class | `reader, writer` tuple |
| Connect | `E4Uclient.open()` | `await telnetlib3.open_connection()` |
| Write | `E4Uclient.write()` | `writer.write(); await writer.drain()` |
| Read | `E4Uclient.read_until()` | `await _async_read_until()` |
| Close | `E4Uclient.close()` | `writer.close(); await writer.wait_closed()` |
| Is Open | `E4Uclient.is_open()` | `writer is not None and not writer.is_closing()` |

---

## Files Changed

### Deleted Files

1. **`custom_components/4noks_elios4you/telnetlib/__init__.py`** - **DELETED**
   - 672 lines removed
   - Bundled synchronous telnetlib no longer needed
   - Replaced by `telnetlib3` external dependency

### Modified Files

2. **`custom_components/4noks_elios4you/api.py`** - Major rewrite
   - Removed `E4Utelnet` class entirely
   - Added new instance variables: `_reader`, `_writer`
   - Added `_async_read_until()` method
   - Added `_async_send_command()` method
   - Converted `_ensure_connected()` to async
   - Converted `_safe_close()` to async
   - Converted `close()` to async
   - Updated `_is_connection_valid()` for new pattern
   - Updated `_get_data_with_retry()` to use async methods
   - Updated `async_get_data()` to use async connection management
   - Updated `telnet_set_relay()` to use async connection management

3. **`custom_components/4noks_elios4you/__init__.py`**
   - Updated `async_unload_entry()` to await async `close()` method:
     ```python
     await config_entry.runtime_data.coordinator.api.close()
     ```

4. **`custom_components/4noks_elios4you/const.py`**
   - Version bump: `0.3.0-beta.2` -> `0.4.0-beta.1`

5. **`custom_components/4noks_elios4you/manifest.json`**
   - Version bump: `0.3.0-beta.2` -> `0.4.0-beta.1`
   - Note: `telnetlib3>=2.0.4` was already in requirements

---

## Breaking Changes

**None for users.** This is an internal architectural change with full backward compatibility.

**For developers:**
- The `close()` method signature changed from sync to async
- Callers must now use `await api.close()` instead of `api.close()`

---

## Preserved Features

All existing features from v0.3.0 are preserved:

- **Connection Pooling:** 25-second reuse window still in effect
- **Command Retry Logic:** 3 retries with 300ms delay between attempts
- **Race Condition Prevention:** `asyncio.Lock` still serializes all operations
- **Silent Timeout Detection:** Incomplete responses are still detected
- **Custom Exceptions:** `TelnetConnectionError` and `TelnetCommandError` unchanged

---

## Testing Recommendations

### Critical Tests

1. **System Responsiveness Test**
   - Start polling with 30-second interval
   - During poll, check if UI remains responsive
   - Verify other integrations continue updating
   - Expected: No noticeable lag during polling

2. **Long-term Stability Test**
   - Deploy and monitor for 24-48 hours minimum
   - Check that all functionality works correctly
   - Monitor for any new error messages in logs

3. **Connection Lifecycle Test**
   - Observe connection open/close in debug logs
   - Verify connections are properly cleaned up
   - Check that connection reuse still works

### Normal Operation Tests

4. **Sensor Updates**
   - Verify sensors update at configured interval
   - Check data accuracy against device display

5. **Switch Entity**
   - Test relay ON/OFF commands
   - Verify state updates immediately

6. **Device Offline/Online**
   - Disconnect device from network
   - Verify sensors show "unavailable"
   - Reconnect device
   - Verify sensors recover

### Edge Cases

7. **Rapid Switch Toggling**
   - Toggle relay switch rapidly (5+ times in quick succession)
   - Verify no errors and proper state tracking

8. **Network Interruption**
   - Briefly interrupt network (router restart)
   - Verify integration recovers gracefully

---

## Why Version 0.4.0?

This release warrants a minor version bump (0.3.x -> 0.4.x) because:

1. **Major Architectural Change:** Complete replacement of telnet implementation
2. **External Dependency Shift:** From bundled code to external library
3. **API Signature Change:** `close()` method is now async
4. **Significant Code Removal:** 672 lines of bundled telnetlib deleted

While there are no user-facing breaking changes, the internal changes are substantial enough to warrant a new minor version.

---

## Known Issues

None at this time. Please report any issues on [GitHub Issues](https://github.com/alexdelprete/ha-4noks-elios4you/issues).

---

## Upgrade Notes

### From v0.3.0-beta.2 or Earlier

1. Update the integration via HACS or manually
2. Restart Home Assistant
3. No configuration changes needed
4. Enable debug logging to verify async operations

### What to Expect

- Improved system responsiveness during polling
- Same sensor values and entity behavior
- Debug logs will show async operation messages
- No visible changes to users

---

## Technical Deep Dive

### Why telnetlib3?

`telnetlib3` was chosen because:

1. **Native Async:** Built from ground-up for `asyncio`
2. **Well-Maintained:** Active development, compatible with Python 3.13
3. **Already a Dependency:** Was listed in `manifest.json` requirements
4. **Protocol Compatible:** Same telnet protocol, just async

### The read_until Challenge

`telnetlib3` provides stream-based I/O (`reader.read()`) but not `read_until()`. The custom `_async_read_until()` implementation:

1. Reads in chunks to buffer
2. Checks for separator after each chunk
3. Respects overall timeout with remaining time tracking
4. Handles EOF and partial data gracefully

This approach mirrors how the original sync `read_until()` worked, but with proper async yielding.

### Connection Validation Update

The connection validity check was updated for the new model:

```python
def _is_connection_valid(self) -> bool:
    if self._writer is None or self._writer.is_closing():
        return False
    if time.time() - self._last_activity > self.CONNECTION_REUSE_TIMEOUT:
        return False
    return True
```

Using `_writer.is_closing()` properly detects connections that are in the process of being closed.

---

## Acknowledgments

### Development Team

- **@alexdelprete** - Integration author, provided direction and approval
- **Claude AI (Opus 4.5)** - Implementation and documentation
- **Claude Code** - VSCode extension for AI-assisted development

### Reference

- **telnetlib3 documentation** - Async telnet client patterns
- **Python asyncio documentation** - Async I/O patterns

---

## Documentation & Support

- **GitHub Repository:** https://github.com/alexdelprete/ha-4noks-elios4you
- **Issues:** https://github.com/alexdelprete/ha-4noks-elios4you/issues
- **Community Forum:** https://community.home-assistant.io/t/custom-component-4-noks-elios4you-data-integration/692883
- **Changelog:** [CHANGELOG.md](../../CHANGELOG.md)

---

## Transparency Statement

This release was developed with assistance from Claude AI (Anthropic's Opus 4.5 model) via the Claude Code VSCode extension. The AI performed:

- Analysis of async telnet migration requirements
- Implementation of telnetlib3-based async client
- Creation of custom `_async_read_until()` helper
- Documentation and release notes creation

All code changes were reviewed and approved by the human developer (@alexdelprete). The AI acted as a development assistant, not an autonomous developer.

---

**Full Changelog:** https://github.com/alexdelprete/ha-4noks-elios4you/compare/v0.3.0-beta.2...v0.4.0-beta.1

---

Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
