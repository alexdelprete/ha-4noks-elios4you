# Release Notes - v0.2.0-beta.1

‚ö†Ô∏è **This is a BETA release** - Please test thoroughly before using in production

## What's Changed

This release brings major code quality and reliability improvements by aligning with patterns and fixes from the ABB Power-One PVI SunSpec integration v4.1.5. The 4noks-elios4you integration is based on the ABB integration's architecture but uses telnet protocol instead of Modbus. This update ports all critical fixes while adapting them for telnet communication.

---

## üêõ Critical Bug Fixes

### Fixed Sensor Availability ‚≠ê **MOST IMPORTANT**

**The Problem:**
- Sensors displayed stale data when the Elios4you device was offline (e.g., at night)
- No indication that the device was unreachable
- Users saw incorrect power readings (e.g., "1.5kW" at midnight when device is offline)
- Stale energy counters could mislead automation and monitoring

**The Solution:**
Changed error handling in `api.py` to raise exceptions when device is unreachable instead of silently failing. This allows Home Assistant's coordinator pattern to properly mark sensors as "unavailable".

**Technical Details:**
- Created custom exception classes: `TelnetConnectionError` and `TelnetCommandError`
- Modified `async_get_data()` to raise exceptions on connection failures
- Exceptions properly propagate through the coordinator to entity states
- Sensors now correctly show "unavailable" state when device is offline

**Files Changed:** `custom_components/4noks_elios4you/api.py`

### Fixed Integration Unload KeyError

**The Problem:**
- KeyError could occur when unloading the integration
- Complex cleanup logic trying to manage `hass.data[DOMAIN]` manually
- Potential for resource leaks

**The Solution:**
Simplified unload logic to rely on Home Assistant's automatic cleanup of `runtime_data`. Removed redundant `hass.data[DOMAIN].pop()` calls that could cause KeyError.

**Files Changed:** `custom_components/4noks_elios4you/__init__.py`

### Fixed Missing Await in Reload

**The Problem:**
- `async_schedule_reload()` was called without `await`
- Could cause RuntimeWarning about unawaited coroutine
- Not following proper async/await patterns

**The Solution:**
Changed to use `async_reload()` with proper `await`, following modern Home Assistant patterns.

**Files Changed:** `custom_components/4noks_elios4you/__init__.py`

### Removed Incorrect PyModbus Import

**The Problem:**
- Config flow was importing `pymodbus.exceptions.ConnectionException`
- This integration doesn't use pymodbus (uses telnet instead)
- Unnecessary dependency and confusing for developers

**The Solution:**
Created telnet-specific custom exceptions (`TelnetConnectionError`, `TelnetCommandError`) and updated config flow to use them.

**Files Changed:** `custom_components/4noks_elios4you/config_flow.py`, `custom_components/4noks_elios4you/api.py`

---

## ‚ú® Code Quality Improvements

### Enhanced Error Handling

- **Custom Exception Classes:** Created `TelnetConnectionError` and `TelnetCommandError` with context (host, port, timeout, command)
- **Better Error Messages:** More informative error messages throughout the codebase
- **Proper Exception Chaining:** Using `raise ... from err` pattern for better error traceability
- **Structured Logging:** Replaced f-strings with % formatting in logging for better performance

### Comprehensive Type Hints

- Added return type hints to all major functions
- Added parameter type hints where missing
- Better IDE support and type safety
- Catches potential bugs at development time

### Code Cleanup

- Removed commented-out migration code
- Fixed typo: "Regiser" ‚Üí "Register"
- Cleaned up verbose comments
- Removed redundant timestamp logging (HA has built-in timestamps)
- Standardized logging patterns across all files
- Improved code formatting with ruff

### Ruff Compliance ‚úÖ

- All ruff checks pass
- Code formatted with ruff 0.14.0
- No linting warnings
- Consistent code style throughout

---

## ‚ôªÔ∏è Modernization

### Aligned with ABB Power-One PVI SunSpec v4.1.5 Patterns

This integration was originally based on the ABB Power-One PVI SunSpec integration but had diverged over time. This release brings it back in alignment with the latest patterns from v4.1.5:

- Exception-based error handling for device unavailability
- Simplified integration lifecycle management
- Modern async/await patterns
- Better separation of concerns
- Improved coordinator error handling

### Home Assistant Best Practices

- Using `config_entry.runtime_data` pattern
- Proper type aliases with `type` keyword
- Modern entity patterns
- Correct exception propagation in coordinators

---

## üì¶ Dependencies

### Required

- **telnetlib3 >= 2.0.4** - For telnet communication with Elios4you devices
- **Home Assistant >= 2025.1.0** - As specified in hacs.json

### Development

- **ruff 0.14.0** - For linting and formatting
- **Python >= 3.13** - Target version updated

---

## üìù Files Changed

### Major Changes

**`custom_components/4noks_elios4you/api.py`**
- Added `TelnetConnectionError` and `TelnetCommandError` exception classes
- Completely rewrote `async_get_data()` to raise exceptions on failure
- Improved error handling with proper exception chaining
- Better logging with structured context
- Added comprehensive type hints
- Removed datetime timestamps from debug logs

**`custom_components/4noks_elios4you/__init__.py`**
- Simplified `async_unload_entry()` to prevent KeyError
- Fixed `async_reload_entry()` to use proper await with `async_reload()`
- Removed commented-out migration code
- Added return type hints to all functions
- Improved error messages
- Cleaned up comments and improved readability

### Minor Changes

**`custom_components/4noks_elios4you/config_flow.py`**
- Removed pymodbus import
- Updated to use custom telnet exceptions
- Added type hints to `get_unique_id()`
- Improved error messages in config flow

**`custom_components/4noks_elios4you/manifest.json`**
- Version bumped to 0.2.0-beta.1

---

## üöÄ Upgrade Notes

### Is This a Safe Upgrade?

‚ö†Ô∏è **This is a BETA release** - While all changes have been carefully implemented and tested with ruff, this release includes significant changes to error handling that need real-world testing.

### What to Test

1. **Device Offline Scenario** (CRITICAL)
   - Turn off your Elios4you device or disconnect it from network
   - Verify sensors show "unavailable" instead of stale data
   - Reconnect device and verify sensors recover properly

2. **Integration Reload**
   - Go to Settings > Devices & Services > 4-noks Elios4you
   - Click "‚ãÆ" menu > "Reload"
   - Verify no errors in logs

3. **Integration Unload/Remove**
   - Try removing and re-adding the integration
   - Verify no KeyError in logs

4. **Normal Operation**
   - Verify all sensors update correctly
   - Verify switch entity works
   - Check that data accuracy is maintained

5. **Config Flow**
   - Try adding a new instance (if you have multiple devices)
   - Verify connection error messages are clear

### Breaking Changes

**None** - This release maintains full backwards compatibility with existing configurations.

### Upgrading from v0.1.0

1. Update via HACS or manually replace files
2. Restart Home Assistant
3. Test the scenarios above
4. Monitor logs for any unexpected errors
5. Report any issues on GitHub

---

## üêõ Known Issues

None at this time. Please report any issues you find on [GitHub Issues](https://github.com/alexdelprete/ha-4noks-elios4you/issues).

---

## üôè Acknowledgments

This release was made possible by:
- **ABB Power-One PVI SunSpec integration v4.1.5** - Provided the patterns and fixes that inspired this work
- **Davide Vertuani** - Original reverse engineering of Elios4you protocol
- **Home Assistant Community** - For feedback and testing

---

## üìö Additional Documentation

- [CLAUDE.md](../../CLAUDE.md) - Technical documentation about the AI-assisted development process
- [CHANGELOG.md](../../CHANGELOG.md) - Complete changelog with all versions
- [README.md](../../README.md) - General integration documentation
- [GitHub Issues](https://github.com/alexdelprete/ha-4noks-elios4you/issues) - Report bugs or request features

---

**Full Changelog:** https://github.com/alexdelprete/ha-4noks-elios4you/compare/v0.1.0...v0.2.0-beta.1
