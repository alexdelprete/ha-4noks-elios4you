# v1.1.0 - Recovery Script, Device Triggers & Enhanced Notifications

**Date:** January 2, 2026
**Claude Model:** Opus 4.5 (claude-opus-4-5-20251101)
**Development Tool:** Claude Code (VSCode Extension)

---

## Overview

This release introduces powerful new automation and monitoring features for the Elios4you integration:

1. **Recovery Script** - Automatic script execution when device stops responding
2. **Device Triggers** - Home Assistant automation triggers for connection events
3. **Enhanced Recovery Notifications** - Detailed timing information in repair notifications
4. **Options Flow UI Improvements** - Better organized configuration dialog

## New Features

### Recovery Script (Optional)

Configure an optional script that automatically executes when the device stops responding. This enables automated recovery actions like restarting your WiFi router or power-cycling network equipment.

**Configuration:**
1. Go to **Settings > Devices & Services > 4-noks Elios4you**
2. Click **Configure** on your device
3. Select a script entity from the **Recovery script** dropdown
4. Configure the **Failures before notification** threshold (1-10)

**Available variables for your script:**
- `device_name` - The configured device name
- `host` - The device IP address
- `port` - The device TCP port

**Example Script (restart WiFi access point):**
```yaml
script:
  restart_wifi_ap:
    alias: "Restart WiFi Access Point"
    sequence:
      - service: switch.turn_off
        target:
          entity_id: switch.wifi_ap_power
      - delay: "00:00:10"
      - service: switch.turn_on
        target:
          entity_id: switch.wifi_ap_power
```

**Use Case:** When the Elios4you device becomes unreachable (e.g., due to WiFi issues), the integration will automatically run your recovery script after the configured number of failures, potentially restoring connectivity without manual intervention.

### Device Triggers for Automations

Added 3 device triggers that fire events when the Elios4you device experiences connectivity changes:

| Trigger Type | Event | Description |
|--------------|-------|-------------|
| `device_unreachable` | Network/TCP connection failed | Device cannot be reached on the network |
| `device_not_responding` | Connected but not responding | Device is reachable but telnet commands fail |
| `device_recovered` | Device responding again | Device recovers after a failure |

**How to Use:**
1. Go to **Settings > Automations & Scenes > Create Automation**
2. Click **Add Trigger** and select **Device**
3. Select your Elios4you device
4. Choose from the available triggers

**Example Automation:**
```yaml
automation:
  - alias: "Elios4you Device Offline Alert"
    trigger:
      - platform: device
        domain: 4noks_elios4you
        device_id: YOUR_DEVICE_ID
        type: device_unreachable
    action:
      - service: notify.mobile_app
        data:
          title: "Elios4you Offline"
          message: "The Elios4you device is unreachable."
```

### Enhanced Recovery Notifications

Improved repair notifications with detailed timing information:

- **Failure started:** Time when the issue began (locale-aware format)
- **Script executed:** Time when recovery script ran (if configured)
- **Recovery time:** Time when device recovered
- **Total downtime:** Compact format (e.g., "5m 23s", "1h 15m")
- **Persistent notifications:** Survive HA restarts, require user acknowledgment

**Example notification (with recovery script):**
```
Title: My Elios4You has recovered

Your Elios4You device is now responding again.

Failure started: 14:32:15
Script executed: 14:32:18
Recovery time: 14:37:38
Total downtime: 5m 23s

The recovery script script.restart_wifi was executed.

Please dismiss this notification to acknowledge.
```

**Example notification (without recovery script):**
```
Title: My Elios4You has recovered

Your Elios4You device is now responding again.

Failure started: 14:32:15
Recovery time: 14:37:38
Total downtime: 5m 23s

Please dismiss this notification to acknowledge.
```

### Options Flow UI Improvements

Rearranged the options flow dialog for better UX and logical grouping:

| Order | Field | Change |
|-------|-------|--------|
| 1 | Recovery script | Moved up (right after variables description) |
| 2 | Enable repair notifications | Unchanged position |
| 3 | Failures before notification | Changed from slider to input box |
| 4 | Polling Period | Moved to bottom |

**Technical changes:**
- Changed `failures_threshold` from slider to `NumberSelector` with `mode=BOX`
- Changed `scan_interval` to `NumberSelector` with `unit_of_measurement="seconds"`
- Reordered schema fields for logical grouping

### Min-Max Validation in Field Labels

All numeric input fields now display their validation ranges for better user guidance:

- TCP port: `(1-65535)`
- Polling Period: `(30-600)`
- Failures threshold: `(1-10)`

## Translations

All 10 languages fully updated with all new features:

| Language | File |
|----------|------|
| English | `translations/en.json` |
| Italian | `translations/it.json` |
| German | `translations/de.json` |
| Spanish | `translations/es.json` |
| French | `translations/fr.json` |
| Portuguese | `translations/pt.json` |
| Estonian | `translations/et.json` |
| Finnish | `translations/fi.json` |
| Norwegian | `translations/nb.json` |
| Swedish | `translations/sv.json` |

## Files Changed

| File | Change Type | Description |
|------|-------------|-------------|
| `device_trigger.py` | NEW | Device trigger implementation |
| `coordinator.py` | MODIFIED | Recovery script execution, trigger firing, downtime tracking |
| `repairs.py` | MODIFIED | Enhanced notification function with timing |
| `__init__.py` | MODIFIED | Register device triggers platform |
| `config_flow.py` | MODIFIED | Recovery script selector, NumberSelector, UI reordering |
| `const.py` | MODIFIED | Version bump, new constants |
| `manifest.json` | MODIFIED | Version bump |
| `translations/*.json` | MODIFIED | All 10 translation files |
| `CHANGELOG.md` | MODIFIED | Release notes |

## ConfigFlow VERSION

ConfigFlow VERSION bumped from 2 to 3 to track this feature addition.

## Breaking Changes

**None** - Full backward compatibility maintained. All new features are optional.

## Upgrade Path

1. Update integration via HACS
2. Restart Home Assistant
3. (Optional) Configure recovery script in Options flow
4. Device triggers will be automatically available for automations
5. Recovery notifications will use new format on next recovery event

## Requirements

- Home Assistant 2025.10.0 or newer
- Python 3.13 or newer

## Beta Testing

This stable release is the result of thorough beta testing:

| Version | Date | Focus |
|---------|------|-------|
| v1.1.0-beta.1 | 2026-01-02 | Device triggers, enhanced recovery notifications |
| v1.1.0-beta.2 | 2026-01-02 | Options flow UI rearrangement |
| **v1.1.0** | 2026-01-02 | Official stable with min-max labels |

---

**Full Changelog:** https://github.com/alexdelprete/ha-4noks-elios4you/compare/v1.0.0...v1.1.0
