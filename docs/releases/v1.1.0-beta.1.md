# v1.1.0-beta.1 - Device Triggers & Enhanced Recovery Notifications

**Date:** January 2, 2026
**Claude Model:** Opus 4.5 (claude-opus-4-5-20251101)
**Development Tool:** Claude Code (VSCode Extension)

---

## Overview

This beta release introduces two new features to improve automation capabilities and provide better visibility into device connectivity issues:

1. **Device Triggers** - Enable Home Assistant automations based on device connection events
2. **Enhanced Recovery Notifications** - Detailed timing information in repair notifications

## New Features

### Device Triggers for Automations

Added 3 device triggers that fire events when the Elios4you device experiences connectivity changes:

| Trigger Type | Event Fired | Description |
|--------------|-------------|-------------|
| `device_unreachable` | Network/TCP connection failed | Device cannot be reached on the network |
| `device_not_responding` | Connected but not responding | Device is reachable but telnet commands fail |
| `device_recovered` | Device responding again | Device recovers after a failure |

**How to Use:**
1. Go to **Settings > Automations & Scenes > Create Automation**
2. Click **Add Trigger** and select **Device**
3. Select your Elios4you device
4. Choose from the available triggers

**Example Automation:**
```yaml
automation:
  - alias: "Elios4you Device Offline Alert"
    trigger:
      - platform: device
        domain: 4noks_elios4you
        device_id: YOUR_DEVICE_ID
        type: device_unreachable
    action:
      - service: notify.mobile_app
        data:
          title: "Elios4you Offline"
          message: "The Elios4you device is unreachable."
```

### Enhanced Recovery Notifications

Improved repair notifications with detailed timing information:

- **Failure started:** Time when the issue began (locale-aware format using `%X`)
- **Script executed:** Time when recovery script ran (if configured)
- **Recovery time:** Time when device recovered
- **Total downtime:** Compact format (e.g., "5m 23s", "1h 15m")
- **Persistent notifications:** Survive HA restarts, require user acknowledgment

**Example notification (with recovery script configured):**
```
Title: My Elios4You has recovered

Your Elios4You device is now responding again.

Failure started: 14:32:15
Script executed: 14:32:18
Recovery time: 14:37:38
Total downtime: 5m 23s

The recovery script script.restart_wifi was executed.

Please dismiss this notification to acknowledge.
```

**Example notification (without recovery script):**
```
Title: My Elios4You has recovered

Your Elios4You device is now responding again.

Failure started: 14:32:15
Recovery time: 14:37:38
Total downtime: 5m 23s

Please dismiss this notification to acknowledge.
```

## Technical Implementation

### Device Triggers (`device_trigger.py`)

New file implementing Home Assistant device triggers:

- `TRIGGER_TYPES` - List of supported trigger types
- `TRIGGER_SCHEMA` - Validation schema for trigger configuration
- `async_get_triggers()` - Returns available triggers for a device
- `async_attach_trigger()` - Attaches automation listener to trigger events

Events are fired via `hass.bus.async_fire()` from the coordinator when connection state changes.

### Coordinator Changes (`coordinator.py`)

- Added `_format_downtime()` helper for compact duration format
- Added `_script_executed_time` tracking variable
- Added `device_id` property for trigger event firing
- Updated `_fire_device_event()` to fire Home Assistant bus events
- Enhanced recovery notification call with timing parameters

### Repairs Changes (`repairs.py`)

- New function signature for `create_recovery_notification()`
- Two translation keys: `recovery_success` and `recovery_success_no_script`
- Added `is_persistent=True` for notifications that survive HA restart
- Parameters: `started_at`, `ended_at`, `downtime`, `script_name`, `script_executed_at`

### Translation Updates

All 10 language files updated with:

1. **Device trigger strings** in `device_automation.trigger_type`:
   - `device_unreachable`
   - `device_not_responding`
   - `device_recovered`

2. **Recovery notification strings** in `issues`:
   - `recovery_success` (with script info)
   - `recovery_success_no_script` (without script)

**Languages:** English, Italian, German, Spanish, French, Portuguese, Estonian, Finnish, Norwegian, Swedish

## Files Changed

| File | Change Type | Description |
|------|-------------|-------------|
| `device_trigger.py` | NEW | Device trigger implementation |
| `coordinator.py` | MODIFIED | Trigger firing, downtime formatting, timing tracking |
| `repairs.py` | MODIFIED | Enhanced notification function |
| `__init__.py` | MODIFIED | Register device triggers platform |
| `config_flow.py` | MODIFIED | ConfigFlow VERSION bump to 3 |
| `translations/*.json` | MODIFIED | All 10 translation files |
| `CHANGELOG.md` | MODIFIED | Release notes |
| `README.md` | MODIFIED | Device triggers documentation |

## ConfigFlow VERSION

Bumped ConfigFlow VERSION from 2 to 3 to track this feature addition.

## Breaking Changes

**None** - Full backward compatibility maintained.

## Testing Recommendations

### Device Triggers Testing

1. **Trigger availability**: Verify triggers appear in automation UI for the device
2. **Event firing**: Disconnect device, verify `device_unreachable` trigger fires
3. **Recovery trigger**: Reconnect device, verify `device_recovered` trigger fires
4. **Automation execution**: Create automation with trigger, verify it executes

### Recovery Notification Testing

1. **Notification content**: Disconnect device, wait for repair issue, verify timing info
2. **Downtime calculation**: Verify downtime format is correct (e.g., "5m 23s")
3. **Persistence**: Create repair issue, restart HA, verify notification persists
4. **Script info**: Configure recovery script, verify script execution time appears
5. **Dismissal**: Verify notification can be dismissed via repair system

## Dependencies

No new dependencies added. Uses existing Home Assistant APIs:
- `homeassistant.helpers.device_registry`
- `homeassistant.components.device_automation`
- `homeassistant.helpers.issue_registry`
- `homeassistant.util.dt`

## Upgrade Path

1. Update integration via HACS
2. Restart Home Assistant
3. Device triggers will be automatically available
4. Recovery notifications will use new format on next recovery event

---

**Full Changelog:** https://github.com/alexdelprete/ha-4noks-elios4you/compare/v1.0.0...v1.1.0-beta.1
