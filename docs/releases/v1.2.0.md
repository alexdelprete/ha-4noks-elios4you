# v1.2.0 - Test Infrastructure & Stability Improvements

[![GitHub Downloads](https://img.shields.io/github/downloads/alexdelprete/ha-4noks-elios4you/v1.2.0/total?style=for-the-badge)](https://github.com/alexdelprete/ha-4noks-elios4you/releases/tag/v1.2.0)

**Date:** January 4, 2026
**Type:** Minor Release

---

## Overview

This release focuses on improved test infrastructure, stability fixes, and better recovery notification handling. It includes all changes from the v1.1.2-beta.1 cycle plus additional test infrastructure improvements.

---

## Changes Since v1.1.1

### Bug Fixes

- **Recovery notifications:** Changed from repair issues to persistent notifications for better reliability
  - Recovery notifications now survive Home Assistant restarts
  - Users must explicitly dismiss notifications to acknowledge recovery
  - More visible and actionable than repair issues

### Test Infrastructure

- **Comprehensive test coverage:** Achieved 98% code coverage with 221 passing tests
- **New test files:**
  - `test_repairs.py` - Tests for recovery notification functionality
  - `test_device_trigger.py` - Tests for device trigger functionality
- **Improved fixtures:**
  - Added `hass.loop` to `mock_hass` fixture for async coordinator tests
  - Added `hass.state` to `mock_hass` fixture for coordinator state checks
  - Resolved missing mock attributes causing test failures
- **Test infrastructure improvements:**
  - Created `requirements-dev.txt` for separated dev dependencies
  - Updated CI workflow for proper pytest-homeassistant-custom-component setup
  - Added pytest plugin registration in `conftest.py`
  - Skipped integration tests that cannot work due to numeric module name limitation

### CI/CD Improvements

- **JSON validation:** Added JSON linting to the lint workflow
- **Test workflow:** Improved test setup with proper dependency installation order

### Documentation

- **CLAUDE.md updates:**
  - Added mandatory pre-commit directive
  - Clarified Release Readiness Checklist items
  - Added download badge format for release notes
  - Added pymarkdown configuration for historical docs

---

## Technical Notes

### Numeric Module Name Limitation

The integration's module name (`4noks_elios4you`) starts with a digit, which is invalid for Python identifiers. This creates limitations:

- **Workaround:** Tests use a symlink (`fournoks_elios4you -> 4noks_elios4you`) for imports
- **Impact:** Some integration tests that rely on Home Assistant's dynamic module loading are skipped
- **Coverage:** Direct unit tests provide equivalent coverage for all skipped functionality

### Test Statistics

| Metric | Value |
|--------|-------|
| Total tests | 231 |
| Passed | 221 |
| Skipped | 10 |
| Coverage | 98% |

---

## Files Changed

### Production Code

- `custom_components/4noks_elios4you/repairs.py` - Use persistent_notification for recovery

### Test Infrastructure

- `tests/conftest.py` - Added pytest plugin registration, improved fixtures
- `tests/test_repairs.py` - Updated for persistent_notification implementation
- `tests/test_config_flow.py` - Improved integration test infrastructure
- `tests/test_coordinator.py` - Fixed async coordinator tests
- `tests/test_device_trigger.py` - New device trigger tests
- `requirements-dev.txt` - New separated dev dependencies

### CI/CD

- `.github/workflows/test.yml` - Improved test setup
- `.github/workflows/lint.yml` - Added JSON validation

### Documentation

- `CLAUDE.md` - Multiple documentation improvements
- `.pymarkdown.json` - Relaxed rules for historical docs

---

## Breaking Changes

**None** - Full backward compatibility maintained.

---

## Upgrade Notes

No special upgrade steps required. Simply update through HACS or manually replace the integration files.

---

## Full Changelog

**Full Changelog:** https://github.com/alexdelprete/ha-4noks-elios4you/compare/v1.1.1...v1.2.0
