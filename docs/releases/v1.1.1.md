# v1.1.1 - Bug Fix and Code Quality Release

**Date:** January 2, 2026
**Type:** Patch Release

## Overview

This patch release fixes a bug in the repairs flow handler and aligns code patterns with ha-sinapsi-alfa for improved maintainability.

## Bug Fixes

### Repairs Flow Handler

Fixed an issue where recovery notifications would appear empty when clicking on them. Added `ConfirmRepairFlow` handler to properly display the notification content.

**File:** `repairs.py`

```python
async def async_create_fix_flow(self, ...) -> ConfirmRepairFlow:
    """Create a fix flow for the repair issue."""
    return ConfirmRepairFlow()
```

## Code Quality Improvements

### Exception Handling Refactoring

Aligned exception handling patterns with ha-sinapsi-alfa:

- Changed from catch-all `except Exception` to specific exceptions (`AttributeError`, `OSError`, `ValueError`, etc.)
- Moved return statements outside try blocks using `else:` pattern
- Created `_require_data()` helper method to abstract raise logic (TRY301 fix)
- Simplified boolean expressions (`x == 1` instead of `True if x == 1 else False`)
- Converted for-loops to list comprehensions where appropriate

### Pre-commit Configuration

Added `.pre-commit-config.yaml` with automated code quality hooks:

- ruff (linting)
- ruff-format (formatting)
- jsonlint (JSON validation)
- yamllint (YAML validation)
- pymarkdown (Markdown linting)

### Test Infrastructure - Symlink Workaround

Replaced `importlib` workaround with symlink approach for test imports (consistent with ty type checker workflow):

**Before:**

```python
import importlib
_elios4you_api = importlib.import_module("custom_components.4noks_elios4you.api")
TelnetConnectionError = _elios4you_api.TelnetConnectionError
```

**After:**

```python
from custom_components.fournoks_elios4you.api import TelnetConnectionError
```

**Benefits:**
- ~40 fewer lines of importlib boilerplate across 11 test files
- Direct imports are cleaner and more Pythonic
- Eliminates E402 linting errors naturally
- Consistent approach with lint workflow (ty type checker)

**Note:** Tests run in CI only due to complex `pytest-homeassistant-custom-component` dependencies.

**CI Workflow Updated:**

```yaml
- name: Create symlink for tests
  run: ln -s 4noks_elios4you custom_components/fournoks_elios4you

- name: Run tests with coverage
  run: pytest tests/ --cov=custom_components/4noks_elios4you -v

- name: Remove symlink
  run: rm custom_components/fournoks_elios4you
```

### Test Updates

Updated tests to match refactored exception handling behavior:

- `test_is_connection_valid_exception_during_check`: Uses `OSError` instead of generic `Exception`
- Removed obsolete tests for catch-all exception handlers
- `test_relay_value_error_during_parsing`: Expects `ValueError` to propagate

## Files Changed

| File | Changes |
|------|---------|
| `manifest.json` | Version 1.1.1 |
| `const.py` | VERSION = "1.1.1" |
| `repairs.py` | Added `async_create_fix_flow()` returning `ConfirmRepairFlow` |
| `api.py` | Refactored exception handling patterns |
| `coordinator.py` | Moved return outside try block |
| `switch.py` | List comprehension, simplified is_on |
| `.pre-commit-config.yaml` | New pre-commit configuration |
| `.github/workflows/test.yml` | Added symlink creation for tests |
| `tests/conftest.py` | Direct imports via symlink |
| `tests/test_api.py` | Direct imports, updated exception tests |
| `tests/test_config_flow.py` | Direct imports via symlink |
| `tests/test_init.py` | Direct imports via symlink |
| `tests/test_coordinator.py` | Direct imports via symlink |
| `tests/test_sensor.py` | Direct imports via symlink |
| `tests/test_switch.py` | Direct imports via symlink |
| `tests/test_helpers.py` | Direct imports via symlink |
| `tests/test_repairs.py` | Direct imports via symlink |
| `tests/test_diagnostics.py` | Direct imports via symlink |
| `CLAUDE.md` | Added local test instructions, directive about tests vs code |

## Upgrade Notes

This is a fully backward-compatible patch release. No breaking changes.

## Links

- [Full Changelog](../../CHANGELOG.md)
- [GitHub Release](https://github.com/alexdelprete/ha-4noks-elios4you/releases/tag/v1.1.1)
