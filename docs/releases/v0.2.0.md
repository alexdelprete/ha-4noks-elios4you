# Release v0.2.0

**Release Date:** 2025-10-15
**Type:** STABLE - Official Release

## Overview

This is the **official stable release** of v0.2.0, marking a significant milestone in the evolution of the 4-noks Elios4you integration. This release includes comprehensive bug fixes, code quality improvements, architecture alignment with industry best practices, and updated dependencies for compatibility with the latest Home Assistant versions.

**This release includes ALL improvements from the beta cycle:** v0.2.0-beta.1, v0.2.0-beta.2, and v0.2.0-beta.3, plus additional dependency updates for Home Assistant 2025.10.x compatibility.

---

## What's Changed Since v0.1.0

### 🐛 Critical Bug Fixes

#### Sensor Availability Fix ⭐ **MOST IMPORTANT**
- **Fixed:** Sensors now properly show "unavailable" when device is offline instead of displaying stale data
- **Impact:** Users were seeing stale production values (e.g., "1.5kW at midnight") when the Elios4you device was offline
- **Solution:** Changed error handling to raise exceptions instead of returning `False`, allowing the coordinator to properly detect offline state
- **Technical Details:**
  - Created custom exception classes: `TelnetConnectionError` and `TelnetCommandError`
  - Modified `async_get_data()` to always raise exceptions on failure
  - Added proper exception chaining with context (host, port, command)

#### Integration Unload Error Fix
- **Fixed:** KeyError during integration unload/removal
- **Solution:** Simplified unload logic to rely on Home Assistant's automatic cleanup
- **Technical Details:**
  - Removed manual `hass.data[DOMAIN]` management
  - Added proper `close()` method to `Elios4YouAPI` class
  - Cleaner error handling in `async_unload_entry()`

#### Async/Await Pattern Fix
- **Fixed:** Missing `await` in reload function
- **Solution:** Corrected to use proper async/await pattern with `async_reload()`
- **Technical Details:** Updated `async_reload_entry()` function signature and implementation

#### Dependency Cleanup
- **Fixed:** Incorrect pymodbus dependency import
- **Solution:** Removed unused pymodbus imports, now uses only telnet-specific exceptions
- **Impact:** Cleaner dependencies, no confusion with Modbus protocol

---

### ♻️ Architecture Improvements

#### Standardized Logging System (v0.2.0-beta.3)

**New `helpers.py` Module:**
- Contextual logging functions: `log_debug()`, `log_info()`, `log_warning()`, `log_error()`
- Consistent format: `(function_name) [context]: message`
- Support for structured context data via kwargs
- Added `host_valid()` utility function for shared validation

**Comprehensive Logging Migration:**
- Updated ALL Python files (~50+ logging calls):
  - `__init__.py` - 5 logger calls updated
  - `api.py` - ~30 logger calls updated
  - `config_flow.py` - 5 logger calls updated
  - `coordinator.py` - 4 logger calls updated
  - `switch.py` - 4 logger calls updated
  - `sensor.py` - 2 logger calls updated
- Removed all f-strings from logging for better performance
- Always includes function context for easier debugging

#### Core Module Refactoring (v0.2.0-beta.3)

**1. Simplified RuntimeData Structure:**
```python
# Old
@dataclass
class RuntimeData:
    coordinator: DataUpdateCoordinator
    update_listener: Callable  # Redundant!

# New
@dataclass
class RuntimeData:
    coordinator: DataUpdateCoordinator  # Clean and simple
```

**2. Enhanced Function Patterns:**
- `async_update_device_registry()` - Changed to `@callback` decorator (correct sync operation)
- `async_reload_entry()` - Now uses `@callback` with `async_schedule_reload()` (non-blocking)
- `async_unload_entry()` - Walrus operator and cleaner error propagation

**3. Migration Infrastructure:**
- Added `async_migrate_entry()` function for future config schema migrations
- Infrastructure ready for when needed

**4. Update Listener Simplification:**
- Reduced from 3 lines to 1 line
- Leverages Home Assistant's automatic cleanup

#### Config Flow Improvements

- Host validation moved to shared `helpers.host_valid()` function
- Removed code duplication
- Consistent error logging with context
- Alphabetically sorted exception imports
- Added type ignore comment for ConfigFlow class

#### Code Formatting Improvements

- Improved readability with line breaks in long logging calls
- Enhanced type hints with return type annotations
- Consistent style according to ruff standards

---

### 📦 Dependencies & Compatibility

**Updated for Home Assistant 2025.10.x:**
- Home Assistant requirement: `2025.10.0+` (was `2025.1.0`)
- Python requirement: `3.13+` (was `3.11`)
- Development dependencies updated:
  - `homeassistant==2025.10.2`
  - `pip>=21.0,<25.3`
- Telnet library: `telnetlib3>=2.0.4` (unchanged)
- Code quality: `ruff==0.14.0`

**CI/CD Updates:**
- GitHub Actions lint workflow now uses Python 3.13
- Ensures compatibility with latest Home Assistant core

---

### ✨ Code Quality Improvements

- **100% Ruff compliance** maintained throughout
- **Comprehensive type hints** added to all functions and classes
- **Enhanced error handling** with proper exception propagation
- **Improved logging patterns** (structured logging with % formatting)
- **Code cleanup** - removed technical debt and commented code
- **8 Python files refactored** (7 existing + 1 new helpers.py)

---

### 🎯 ABB Power-One v4.1.5 Alignment

Successfully adopted the following patterns from the reference implementation:
- ✅ Contextual helper logging functions
- ✅ Custom exception classes with context
- ✅ `@callback` decorator for sync operations
- ✅ Non-blocking reload with `async_schedule_reload()`
- ✅ Clean error propagation in unload
- ✅ Simplified RuntimeData structure
- ✅ Migration infrastructure
- ✅ DRY principle with shared utilities

---

## Beta Testing Cycle

This stable release is the result of a thorough beta testing cycle:

- **v0.2.0-beta.1** (2025-10-12) - Critical bug fixes and code quality improvements
- **v0.2.0-beta.2** (2025-10-12) - Hotfix for integration unload error
- **v0.2.0-beta.3** (2025-10-13) - Architecture alignment and logging standardization
- **v0.2.0** (2025-10-15) - Official stable release with dependency updates

Detailed release notes for each beta are available in this directory.

---

## Breaking Changes

**None for existing users**. This is a code quality and bug fix release with full backward compatibility.

**For new installations:**
- Requires Home Assistant 2025.10.0 or newer
- Requires Python 3.13 or newer

---

## Files Changed

### New Files:
- `custom_components/4noks_elios4you/helpers.py` - Standardized utility functions

### Modified Files:
- `.github/workflows/lint.yml` - Python 3.13 update
- `requirements.txt` - Updated dependencies
- `hacs.json` - Updated HA requirement
- `custom_components/4noks_elios4you/manifest.json` - Version bump to 0.2.0
- `custom_components/4noks_elios4you/__init__.py` - Core lifecycle refactoring
- `custom_components/4noks_elios4you/api.py` - Exception classes and logging
- `custom_components/4noks_elios4you/config_flow.py` - Host validation and logging
- `custom_components/4noks_elios4you/coordinator.py` - Logging standardization
- `custom_components/4noks_elios4you/switch.py` - Logging standardization
- `custom_components/4noks_elios4you/sensor.py` - Logging standardization

---

## Installation

### Via HACS (Recommended)

1. Open HACS in Home Assistant
2. Go to Integrations
3. Search for "4-noks Elios4You"
4. Click Update to v0.2.0

### Manual Installation

1. Download `4noks_elios4you.zip` from the [release assets](https://github.com/alexdelprete/ha-4noks-elios4you/releases/tag/v0.2.0)
2. Extract to `custom_components/4noks_elios4you/`
3. Restart Home Assistant

---

## Upgrade Notes

### From v0.1.0 (Stable)

**Prerequisites:**
- Ensure you're running Home Assistant 2025.10.0 or newer
- Python 3.13 or newer is required

**Upgrade Process:**
1. Update the integration via HACS or manually
2. Restart Home Assistant
3. No configuration changes needed - integration will work automatically
4. (Optional) Enable debug logging to see improved log format

**What to Expect:**
- Sensors will now properly show "unavailable" when device is offline
- Integration unload/reload will be cleaner with no errors
- Debug logs will have better formatting if enabled
- No visible changes to entity behavior - everything works as before, but better

### From Beta Versions

**From v0.2.0-beta.3:**
- Simple update, no changes needed
- Only dependency versions updated

**From v0.2.0-beta.2 or earlier:**
- All improvements from beta.3 are included
- Review [v0.2.0-beta.3 release notes](v0.2.0-beta.3.md) for architecture changes

**From v0.2.0-beta.1:**
- All improvements from beta.2 and beta.3 are included
- Review all beta release notes for complete details

---

## Testing Validation

The following testing has been performed through the beta cycle:

### ✅ Critical Tests
- [x] Device offline → Sensors show "unavailable" (not stale data)
- [x] Device reconnect → Sensors recover correctly
- [x] Integration reload → No errors, clean reload
- [x] Integration unload → No KeyError, proper cleanup
- [x] Integration setup from scratch → Works correctly

### ✅ Normal Operations
- [x] Sensor data updates at configured interval
- [x] Data accuracy verified against device display
- [x] Calculated sensors (self-consumption) correct
- [x] Switch entity (relay) ON/OFF works
- [x] State updates immediately

### ✅ Config Flow
- [x] Adding new integration instance works
- [x] Connection validation functions correctly
- [x] Error messages clear and helpful
- [x] Options flow (changing host, port, interval) works

### ✅ Edge Cases
- [x] Intermittent connection handled gracefully
- [x] Invalid responses handled with proper errors
- [x] Multiple instances don't interfere

### ✅ Code Quality
- [x] 100% ruff compliance
- [x] No linting warnings
- [x] Comprehensive type hints
- [x] All logging consistent

---

## Known Issues

None reported at this time.

If you encounter any issues, please report them on [GitHub Issues](https://github.com/alexdelprete/ha-4noks-elios4you/issues).

---

## For Developers

### New Logging Pattern

**Old:**
```python
_LOGGER.debug(f"Connecting to {host}:{port}")
_LOGGER.error("Connection failed: %s", err)
```

**New:**
```python
from .helpers import log_debug, log_error

log_debug(_LOGGER, "async_connect", "Connecting to device", host=host, port=port)
log_error(_LOGGER, "async_connect", "Connection failed", error=err)
```

**Benefits:**
- Always know which function logged the message
- Structured context data (searchable, filterable)
- Consistent format across entire codebase
- No f-strings (better performance)

### Exception Handling Pattern

**Old:**
```python
try:
    # operation
    return True
except:
    return False  # Silent failure
```

**New:**
```python
try:
    # operation
    return True
except TimeoutError as err:
    raise TelnetConnectionError(host, port, timeout, str(err)) from err
except Exception as err:
    raise TelnetCommandError(cmd, str(err)) from err
```

### Migration Function Template

If you need to add a config migration in the future:

```python
async def async_migrate_entry(hass: HomeAssistant, config_entry: ConfigEntry) -> bool:
    """Migrate old config entries."""
    log_debug(_LOGGER, "async_migrate_entry", "Migrating config entry",
              version=config_entry.version)

    if config_entry.version == 1:
        new_data = {**config_entry.data}
        # Perform migration logic here
        hass.config_entries.async_update_entry(config_entry, data=new_data, version=2)
        log_info(_LOGGER, "async_migrate_entry", "Migration to version 2 complete")

    return True
```

---

## Acknowledgments

### Development Team

- **@alexdelprete** - Integration author and maintainer
- **Claude AI (Sonnet 4.5)** - Code analysis, implementation, and documentation
- **Claude Code** - VSCode extension for seamless AI-assisted development

### Inspiration & Reference

- **ABB Power-One PVI SunSpec v4.1.5** - Reference implementation for patterns and fixes
- **Home Assistant Core Team** - For excellent integration patterns and documentation
- **Davide Vertuani** - Original Elios4you protocol reverse engineering

### Community

- **Home Assistant Community** - For feedback and support
- **HACS** - For making custom integrations accessible
- **Beta Testers** - For validating the beta releases

---

## Documentation & Support

- **GitHub Repository:** https://github.com/alexdelprete/ha-4noks-elios4you
- **Issues:** https://github.com/alexdelprete/ha-4noks-elios4you/issues
- **Discussions:** https://github.com/alexdelprete/ha-4noks-elios4you/discussions
- **Community Forum:** https://community.home-assistant.io/t/custom-component-4-noks-elios4you-data-integration/692883
- **Changelog:** [CHANGELOG.md](../../CHANGELOG.md)
- **Beta Release Notes:**
  - [v0.2.0-beta.1](v0.2.0-beta.1.md)
  - [v0.2.0-beta.2](v0.2.0-beta.2.md)
  - [v0.2.0-beta.3](v0.2.0-beta.3.md)

---

## Transparency Statement

This release was developed with assistance from Claude AI (Anthropic's Sonnet 4.5 model) via the Claude Code VSCode extension. All code changes were:

- Analyzed and reviewed by human developer (@alexdelprete)
- Based on proven patterns from existing working code
- Tested through a comprehensive beta cycle
- Validated with automated linting tools
- Documented comprehensively for future reference

The AI acted as a development assistant, not an autonomous developer. Human oversight and judgment guided all decisions.

---

**Full Changelog:** https://github.com/alexdelprete/ha-4noks-elios4you/compare/v0.1.0...v0.2.0

---

🎉 **Thank you for using the 4-noks Elios4you integration!**

Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
